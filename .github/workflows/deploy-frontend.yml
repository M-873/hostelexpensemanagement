name: Frontend Deployment to Vercel

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
      - 'frontend/vercel.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

jobs:
  test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linting
      run: npm run lint
    
    - name: Type checking
      run: npm run type-check --if-present
    
    - name: Build frontend
      run: npm run build
    
    - name: Validate build output
      run: |
        if [ ! -d "dist" ]; then
          echo "âŒ Build output not found"
          exit 1
        fi
        
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ index.html not found in build output"
          exit 1
        fi
        
        echo "âœ… Build output validated"
        echo "ğŸ“¦ Build size: $(du -sh dist | cut -f1)"
    
    - name: Run tests (if available)
      run: npm test --if-present

  deploy:
    name: Deploy to Vercel
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: frontend
      run: npm run build
    
    - name: Validate deployment readiness
      working-directory: frontend
      run: |
        # Check if all required files exist
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ index.html not found in build output"
          exit 1
        fi
        
        if [ ! -f "vercel.json" ]; then
          echo "âŒ vercel.json not found"
          exit 1
        fi
        
        echo "âœ… Deployment readiness validated"
    
    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: frontend
        vercel-args: '--prod'
        vercel-project-name: 'hostel-expense-frontend'
    
    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        sleep 10
        
        # Get deployment URL from Vercel
        deployment_url=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
          "https://api.vercel.com/v6/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}&limit=1" | \
          grep -o '"url":"[^"]*"' | head -1 | cut -d'"' -f4)
        
        if [ -n "$deployment_url" ]; then
          echo "âœ… Deployment URL: https://$deployment_url"
          echo "VERCEL_URL=$deployment_url" >> $GITHUB_ENV
        else
          echo "âš ï¸ Could not retrieve deployment URL"
        fi
    
    - name: Run health check
      if: env.VERCEL_URL
      run: |
        echo "ğŸ¥ Running health check..."
        max_attempts=5
        attempt=0
        
        while [ $attempt -lt $max_attempts ]; do
          response=$(curl -s -o /dev/null -w "%{http_code}" "https://${VERCEL_URL}")
          
          if [ "$response" = "200" ]; then
            echo "âœ… Health check passed (HTTP 200)"
            exit 0
          else
            echo "ğŸ”„ Health check attempt $((attempt + 1))/$max_attempts: HTTP $response"
            sleep 10
            attempt=$((attempt + 1))
          fi
        done
        
        echo "âš ï¸ Health check did not pass within expected time"
    
    - name: Deployment Summary
      if: always()
      run: |
        echo "ğŸ¯ Frontend Deployment Summary"
        echo "============================="
        echo ""
        echo "ğŸ“Š Status: ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }}"
        echo "ğŸ”„ Trigger: ${{ github.event_name }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo ""
        if [ -n "$VERCEL_URL" ]; then
          echo "ğŸŒ Deployment URL: https://$VERCEL_URL"
        fi
        echo ""
        echo "ğŸ”— Check your deployment at:"
        echo "   - Vercel Dashboard: https://vercel.com/dashboard"
        echo "   - Project Settings: https://vercel.com/${{ secrets.VERCEL_ORG_ID }}/${{ secrets.VERCEL_PROJECT_ID }}/settings"
        echo ""
        echo "ğŸ“‹ Environment Variables configured in Vercel:"
        echo "   - VITE_API_URL: Your backend API URL"
        echo "   - VITE_SOCKET_URL: Your WebSocket URL"