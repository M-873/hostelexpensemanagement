name: Deploy Frontend to Vercel

on:
  push:
    branches:
      - master
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
      
      - name: Clone frontend deployment repo
        env:
          FRONTEND_DEPLOY_TOKEN: ${{ secrets.FRONTEND_DEPLOY_TOKEN }}
        run: |
          git clone https://x-access-token:${FRONTEND_DEPLOY_TOKEN}@github.com/M-873/hostelexpensemanagement1.git frontend-deploy
      
      - name: Sync frontend code
        run: |
          # Use rsync to sync files while excluding unwanted directories
          # rsync -av --delete --exclude='.git' --exclude='node_modules' --exclude='dist' --exclude='.vercel' --exclude='.vite' frontend/ frontend-deploy/
          
          # Since rsync might not be exactly what we want if we're deleting everything else anyway,
          # let's stick to find/cp but exclude node_modules.
          
          # Clean deployment repo except .git
          find frontend-deploy -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # Copy frontend files excluding node_modules and other artifacts
          # Use a temporary folder to prepare the sync
          mkdir -p temp_sync
          cp -r frontend/* temp_sync/
          rm -rf temp_sync/node_modules
          rm -rf temp_sync/dist
          rm -rf temp_sync/.vercel
          rm -rf temp_sync/.vite
          
          cp -r temp_sync/* frontend-deploy/
          rm -rf temp_sync
          
          # Copy root package.json files if needed
          if [ -f "package.json" ]; then
            cp package.json frontend-deploy/package-root.json 2>/dev/null || true
          fi
      
      - name: Commit and push changes
        working-directory: frontend-deploy
        run: |
          git add .
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Sync from monorepo: ${{ github.sha }}"
          git push origin master
      
      - name: Trigger Vercel deployment
        if: success()
        run: |
          echo "âœ… Frontend code synced successfully"
          echo "Vercel will automatically deploy from the updated repository"
          echo "Monitor deployment at: https://vercel.com/md-mahfuzul-islams-projects/frontend"
