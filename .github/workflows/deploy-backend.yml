name: Backend Deployment to Render

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  test:
    name: Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: Install dependencies
      run: npm ci
    
    - name: Generate Prisma client
      run: npx prisma generate
    
    - name: Run linting
      run: npm run lint
    
    - name: Build backend
      run: npm run build
    
    - name: Validate build output
      run: |
        if [ ! -d "dist" ]; then
          echo "âŒ Build output not found"
          exit 1
        fi
        echo "âœ… Build output validated"
    
    - name: Run tests (if available)
      run: npm test --if-present

  deploy:
    name: Deploy to Render
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: Install dependencies
      working-directory: backend
      run: npm ci
    
    - name: Generate Prisma client
      working-directory: backend
      run: npx prisma generate
    
    - name: Build backend
      working-directory: backend
      run: npm run build
    
    - name: Validate deployment readiness
      working-directory: backend
      run: |
        # Check if all required files exist
        if [ ! -f "dist/server.js" ]; then
          echo "âŒ Server file not found in build output"
          exit 1
        fi
        
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json not found"
          exit 1
        fi
        
        echo "âœ… Deployment readiness validated"
    
    - name: Deploy to Render
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        echo "ğŸš€ Triggering Render deployment..."
        
        # Trigger deployment via Render API
        response=$(curl -s -X POST \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"clearCache": "clear"}' \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys")
        
        echo "ğŸ“¡ Render API Response: $response"
        
        # Check if deployment was triggered successfully
        if echo "$response" | grep -q "id"; then
          deploy_id=$(echo "$response" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
          echo "âœ… Render deployment triggered successfully!"
          echo "ğŸ“ Deployment ID: $deploy_id"
          echo "RENDER_DEPLOY_ID=$deploy_id" >> $GITHUB_ENV
        else
          echo "âŒ Render deployment failed"
          echo "Response: $response"
          exit 1
        fi
    
    - name: Wait for deployment (optional)
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        if [ -n "$RENDER_DEPLOY_ID" ]; then
          echo "â³ Waiting for deployment to complete..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            status_response=$(curl -s \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$RENDER_DEPLOY_ID")
            
            deploy_status=$(echo "$status_response" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
            
            echo "ğŸ”„ Deployment status: $deploy_status (attempt $((attempt + 1))/$max_attempts)"
            
            case "$deploy_status" in
              "live")
                echo "âœ… Deployment completed successfully!"
                exit 0
                ;;
              "build_failed"|"update_failed"|"deactivated")
                echo "âŒ Deployment failed with status: $deploy_status"
                exit 1
                ;;
              *)
                sleep 30
                attempt=$((attempt + 1))
                ;;
            esac
          done
          
          echo "âš ï¸ Deployment check timeout - please check Render dashboard manually"
        fi
    
    - name: Deployment Summary
      if: always()
      run: |
        echo "ğŸ¯ Backend Deployment Summary"
        echo "============================="
        echo ""
        echo "ğŸ“Š Status: ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }}"
        echo "ğŸ”„ Trigger: ${{ github.event_name }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo ""
        if [ -n "$RENDER_DEPLOY_ID" ]; then
          echo "ğŸ“ Deployment ID: $RENDER_DEPLOY_ID"
        fi
        echo ""
        echo "ğŸ”— Check your deployment at:"
        echo "   - Render Dashboard: https://dashboard.render.com"
        echo "   - Service Logs: Check the Render service logs for detailed information"